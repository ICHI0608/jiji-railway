# 🎯 **エラー解決手法 - 根本原因アプローチ**

**作成日**: 2025年7月27日  
**基準事例**: Railway Supabase API key問題解決  
**成功パターン**: 根本原因思考 + 段階的アプローチ + 事実ベース確認

---

## 🔥 **必須マインドセット**

### **❌ 絶対に避けるべき思考パターン**
- 表面的な症状への場当たり対処
- 推測ベースでの修正実装
- 環境差異の軽視
- Git管理の軽視
- デプロイ確認の怠慢

### **✅ 必須の思考パターン**
- **根本原因思考**: "なぜこのエラーが継続するのか？"
- **段階的アプローチ**: 調査 → 分析 → 修正 → デプロイ → 確認
- **事実ベース**: 推測でなく実際の状態確認
- **環境差異重視**: ローカル vs リモートの状態比較
- **Git管理徹底**: 修正 → add → commit → push → 確認

---

## 🛠️ **エラー解決の標準手順**

### **Phase 1: 現状完全把握**
```bash
# 1. リモート環境の実際の状態確認
curl -s https://[production-url]/api/health
curl -s https://[production-url]/[error-endpoint]

# 2. ローカル環境の状態確認  
curl -s http://localhost:[port]/api/health
curl -s http://localhost:[port]/[error-endpoint]

# 3. Git管理状態確認
git status
git log --oneline -5
git diff HEAD~1 [問題のファイル]
```

### **Phase 2: 根本原因分析**
```bash
# 環境差異の特定
- ローカル正常 × リモートエラー → デプロイ問題
- ローカルエラー × リモートエラー → コード問題  
- 両方正常だが機能エラー → API/DB接続問題

# 具体的確認方法
WebFetch "[production-url]" "現在の動作状況詳細分析"
LS /path/to/project (ファイル構成確認)
Read [問題のファイル] (コード内容確認)
```

### **Phase 3: 的確な修正実装**
```bash
# 修正前の状態保存
cp [問題のファイル] [問題のファイル].backup

# 段階的修正
Edit [問題のファイル] # 1つずつ確実に修正
Bash "curl localhost test" # ローカルで即座確認

# フォールバック機能の実装
- 外部サービス依存の最小化
- エラー時の代替動作確保
- 詳細ログ出力機能
```

### **Phase 4: 確実なデプロイ**
```bash
# Git管理の徹底
git add [修正ファイル]
git commit -m "fix: [根本原因] - [具体的修正内容]

- [問題の詳細説明]
- [実施した修正]
- [テスト結果]

Fixes: [issue]
Resolves: [problem]"

git push origin main

# デプロイ確認（重要！）
sleep 60  # デプロイ完了待機
curl -s https://[production-url]/api/health # 状態確認
```

### **Phase 5: 動作確認と学習**
```bash
# 機能テスト
curl -X POST https://[production-url]/[test-endpoint] \
  -H "Content-Type: application/json" \
  -d '[test-data]'

# 学習ポイント整理
TodoWrite で解決プロセス記録
原因と対策をドキュメント化
```

---

## 📋 **エラー別対応パターン**

### **🔧 Railway/Vercel デプロイ問題**
**症状**: ローカル正常、本番エラー
**原因**: コード未反映、環境変数、設定問題
**対策**: 
1. `git status`でローカル変更確認
2. `git push`でデプロイ確実実行
3. デプロイ後の状態確認（30-60秒後）

### **🗄️ Database接続問題**
**症状**: "Invalid API key", "Connection failed"
**原因**: 認証情報、ネットワーク、権限問題
**対策**:
1. 環境変数の値確認（マスク表示でOK）
2. 接続テスト機能の実装
3. フォールバック機能の実装

### **🔗 API統合問題**  
**症状**: "404 Not Found", "500 Internal Server Error"
**原因**: エンドポイント不一致、データ形式、認証問題
**対策**:
1. エンドポイントの存在確認
2. リクエスト/レスポンス形式確認
3. 段階的テスト（ローカル → 本番）

---

## 🎯 **成功事例: Railway Supabase問題**

### **問題概要**
- エラー: "Invalid API key" 継続
- 環境: Railway本番環境のみ
- 期間: 複数セッション継続

### **失敗パターン（以前）**
```bash
❌ 症状対処アプローチ
API keyエラー → 環境変数再設定 → エラー継続
→ 別の修正 → エラー継続 → 繰り返し
```

### **成功パターン（今回）**
```bash
✅ 根本原因アプローチ  
1. 現状調査: curl health check (ローカル vs 本番)
2. 原因特定: git status → 修正未反映発見
3. 修正実装: API key検証 + フォールバック機能
4. 確実デプロイ: git add/commit/push
5. 動作確認: 本番環境での機能テスト
```

### **解決の決定要因**
1. **事実ベース確認**: curl での実際の状態把握
2. **環境差異分析**: ローカル動作 vs 本番エラー
3. **Git管理徹底**: 修正コードの確実な反映
4. **段階的アプローチ**: 一つずつ確実に進行

---

## 🔧 **ツール使用テンプレート**

### **TodoWrite 使用パターン**
```json
[
  {"content": "[問題]の現状完全調査", "status": "in_progress"},
  {"content": "根本原因の特定", "status": "pending"},
  {"content": "環境差異分析", "status": "pending"},
  {"content": "修正版の確実なデプロイ", "status": "pending"},
  {"content": "動作確認と学習まとめ", "status": "pending"}
]
```

### **調査コマンドセット**
```bash
# 必須確認コマンド
curl -s [production-url]/api/health
git status
git log --oneline -3
git diff HEAD~1 [file]

# 詳細調査
WebFetch "[url]" "現在の状況詳細分析"
Read [config-file]
LS [project-directory]

# デプロイ後確認
sleep 60
curl -s [production-url]/[test-endpoint]
```

---

## 📝 **学習記録テンプレート**

### **問題解決レポート形式**
```markdown
## 問題概要
- エラー内容: [具体的エラー]
- 発生環境: [環境詳細]  
- 継続期間: [期間]

## 根本原因
- 直接原因: [技術的原因]
- 背景要因: [なぜ発生したか]

## 解決手順
1. [調査フェーズ]
2. [分析フェーズ]  
3. [修正フェーズ]
4. [デプロイフェーズ]
5. [確認フェーズ]

## 学習ポイント
- 技術面: [技術的学習]
- プロセス面: [手順改善]
- 予防策: [再発防止]
```

---

## ⚡ **緊急時チェックリスト**

### **🚨 同じエラーが継続する場合**
```markdown
□ git status で未反映変更確認
□ git diff で変更内容確認
□ ローカル vs 本番の状態比較
□ 環境変数の実際の値確認（マスク表示）
□ デプロイ後の十分な待機時間
□ 段階的テスト（機能別）
□ ログファイルの詳細確認
□ フォールバック機能の動作確認
```

### **🎯 絶対確認事項**
1. **修正コードの反映**: `git push` 実行確認
2. **デプロイ完了**: 30-60秒後の状態確認
3. **環境差異**: ローカル動作 vs 本番動作
4. **実際の状態**: curl での事実確認

---

## 💪 **成功の秘訣**

### **マインド**
- **根本思考**: "なぜ?" を3回繰り返す
- **事実重視**: 推測でなく確認
- **段階的**: 一つずつ確実に
- **学習志向**: 解決だけでなく理解

### **手順**
- **調査 → 分析 → 修正 → デプロイ → 確認**
- **各段階でTodoWrite使用**
- **Git管理の徹底**
- **環境差異の重視**

---

**この手法を必ず適用し、同じ問題の再発を防止します。**

**📅 最終更新**: 2025年7月27日  
**📈 適用実績**: Railway Supabase API key問題 - 成功解決  
**🔄 次回更新**: 新しい問題解決事例発生時