# ðŸ—„ï¸ Jiji V2.8.1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Ÿè£…è¨˜éŒ²
**ã€V2.8å®Ÿè£…å®Œäº†ç‰ˆ - å®Ÿéš›ã«æ§‹ç¯‰ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ è¨˜éŒ²ã€‘**

## ðŸ“‹ **ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¤ã„ã¦**

**ç›®çš„**: V2.8ã§å®Ÿè£…ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ ãƒ»é–¢æ•°ãƒ»è¨­å®šã‚’æ­£ç¢ºã«è¨˜éŒ²
**åŸºæº–**: å®Ÿéš›ã«ä½œæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ã‚³ãƒ¼ãƒ‰ã®ã¿ã‚’è¨˜è¼‰
**è¨˜éŒ²æ—¥**: 2025å¹´7æœˆ16æ—¥
**å…ƒãƒ•ã‚¡ã‚¤ãƒ«**: `docs/v28_database_setup.sql`ï¼ˆå®Œå…¨å®Ÿè£…æ¸ˆã¿ï¼‰

---

## âœ… **å®Ÿè£…æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«**

### ðŸ“ **ãƒ¡ã‚¤ãƒ³SQLãƒ•ã‚¡ã‚¤ãƒ«**
**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `docs/v28_database_setup.sql`
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… å®Œå…¨å®Ÿè£…æ¸ˆã¿ï¼ˆ201è¡Œï¼‰
**ä½œæˆè€…**: V2.8é–‹ç™ºãƒãƒ¼ãƒ 
**å®Ÿè£…æ—¥**: 2025å¹´7æœˆ15æ—¥

---

## âœ… **å®Ÿè£…æ¸ˆã¿ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ **

### ðŸª **1. ã‚·ãƒ§ãƒƒãƒ—ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«**
```sql
-- å®Ÿè£…æ¸ˆã¿: B2BåŽç›ŠåŒ–ã‚·ã‚¹ãƒ†ãƒ 
CREATE TABLE IF NOT EXISTS shop_subscriptions (
    id SERIAL PRIMARY KEY,
    shop_id VARCHAR(50) NOT NULL,
    plan_type VARCHAR(20) NOT NULL CHECK (plan_type IN ('premium', 'standard', 'basic')),
    monthly_fee INTEGER NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE,
    status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'cancelled')),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- å®Ÿè£…æ¸ˆã¿ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX IF NOT EXISTS idx_shop_subscriptions_shop_id ON shop_subscriptions(shop_id);
CREATE INDEX IF NOT EXISTS idx_shop_subscriptions_status ON shop_subscriptions(status);
CREATE INDEX IF NOT EXISTS idx_shop_subscriptions_plan_type ON shop_subscriptions(plan_type);
```

**ç”¨é€”**: 
- ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ï¼ˆÂ¥5,000/æœˆï¼‰
- ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ï¼ˆÂ¥3,000/æœˆï¼‰  
- ãƒ™ãƒ¼ã‚·ãƒƒã‚¯ï¼ˆÂ¥0/æœˆï¼‰

### ðŸ“ **2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«**
```sql
-- å®Ÿè£…æ¸ˆã¿: å£ã‚³ãƒŸé‡è¦–ãƒžãƒƒãƒãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ 
CREATE TABLE IF NOT EXISTS user_reviews (
    id SERIAL PRIMARY KEY,
    review_id VARCHAR(100) UNIQUE NOT NULL,
    shop_id VARCHAR(50) NOT NULL,
    line_user_id VARCHAR(100) NOT NULL,
    overall_rating DECIMAL(2,1) CHECK (overall_rating >= 1 AND overall_rating <= 5),
    beginner_friendliness DECIMAL(2,1) CHECK (beginner_friendliness >= 1 AND beginner_friendliness <= 5),
    safety_rating DECIMAL(2,1) CHECK (safety_rating >= 1 AND safety_rating <= 5),
    staff_rating DECIMAL(2,1) CHECK (staff_rating >= 1 AND staff_rating <= 5),
    satisfaction_rating DECIMAL(2,1) CHECK (satisfaction_rating >= 1 AND satisfaction_rating <= 5),
    cost_performance DECIMAL(2,1) CHECK (cost_performance >= 1 AND cost_performance <= 5),
    detailed_review TEXT,
    photos JSONB DEFAULT '[]',
    experience_date DATE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- å®Ÿè£…æ¸ˆã¿ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX IF NOT EXISTS idx_user_reviews_shop_id ON user_reviews(shop_id);
CREATE INDEX IF NOT EXISTS idx_user_reviews_line_user_id ON user_reviews(line_user_id);
CREATE INDEX IF NOT EXISTS idx_user_reviews_created_at ON user_reviews(created_at);
CREATE INDEX IF NOT EXISTS idx_user_reviews_overall_rating ON user_reviews(overall_rating);
```

**è©•ä¾¡é …ç›®**:
- ç·åˆæº€è¶³åº¦ï¼ˆoverall_ratingï¼‰
- åˆå¿ƒè€…å¯¾å¿œåº¦ï¼ˆbeginner_friendlinessï¼‰
- å®‰å…¨æ€§ï¼ˆsafety_ratingï¼‰
- ã‚¹ã‚¿ãƒƒãƒ•å¯¾å¿œï¼ˆstaff_ratingï¼‰
- ä½“é¨“æº€è¶³åº¦ï¼ˆsatisfaction_ratingï¼‰
- ã‚³ã‚¹ãƒˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ï¼ˆcost_performanceï¼‰

### ðŸŽ **3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒã‚¤ãƒ³ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«**
```sql
-- å®Ÿè£…æ¸ˆã¿: ãƒã‚¤ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ 
CREATE TABLE IF NOT EXISTS user_points (
    id SERIAL PRIMARY KEY,
    line_user_id VARCHAR(100) NOT NULL,
    action_type VARCHAR(50) NOT NULL,
    points_earned INTEGER DEFAULT 0,
    points_spent INTEGER DEFAULT 0,
    balance INTEGER NOT NULL,
    description TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- å®Ÿè£…æ¸ˆã¿ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX IF NOT EXISTS idx_user_points_line_user_id ON user_points(line_user_id);
CREATE INDEX IF NOT EXISTS idx_user_points_created_at ON user_points(created_at);
CREATE INDEX IF NOT EXISTS idx_user_points_action_type ON user_points(action_type);
```

**ãƒã‚¤ãƒ³ãƒˆç²å¾—æ–¹æ³•**:
- å£ã‚³ãƒŸæŠ•ç¨¿: 100-200ãƒã‚¤ãƒ³ãƒˆ
- è©³ç´°ãƒ¬ãƒ“ãƒ¥ãƒ¼: +50ãƒã‚¤ãƒ³ãƒˆ
- å†™çœŸä»˜ã: +50ãƒã‚¤ãƒ³ãƒˆ
- å‹é”ç´¹ä»‹: 300ãƒã‚¤ãƒ³ãƒˆ

### ðŸ‘¤ **4. ä¼šå“¡ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«**
```sql
-- å®Ÿè£…æ¸ˆã¿: ä¼šå“¡ã‚·ã‚¹ãƒ†ãƒ 
CREATE TABLE IF NOT EXISTS member_profiles (
    id SERIAL PRIMARY KEY,
    line_user_id VARCHAR(100) UNIQUE NOT NULL,
    registration_date DATE NOT NULL,
    total_points INTEGER DEFAULT 0,
    membership_level VARCHAR(20) DEFAULT 'basic',
    profile_completion_rate INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- å®Ÿè£…æ¸ˆã¿ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX IF NOT EXISTS idx_member_profiles_line_user_id ON member_profiles(line_user_id);
CREATE INDEX IF NOT EXISTS idx_member_profiles_membership_level ON member_profiles(membership_level);
```

---

## âœ… **å®Ÿè£…æ¸ˆã¿åˆ†æžãƒ“ãƒ¥ãƒ¼**

### ðŸ“Š **ã‚·ãƒ§ãƒƒãƒ—å¹³å‡è©•ä¾¡ãƒ“ãƒ¥ãƒ¼**
```sql
-- å®Ÿè£…æ¸ˆã¿: ã‚·ãƒ§ãƒƒãƒ—è©•ä¾¡åˆ†æž
CREATE OR REPLACE VIEW shop_average_ratings AS
SELECT 
    shop_id,
    COUNT(*) as review_count,
    ROUND(AVG(overall_rating), 1) as avg_overall_rating,
    ROUND(AVG(beginner_friendliness), 1) as avg_beginner_friendliness,
    ROUND(AVG(safety_rating), 1) as avg_safety_rating,
    ROUND(AVG(staff_rating), 1) as avg_staff_rating,
    ROUND(AVG(satisfaction_rating), 1) as avg_satisfaction_rating,
    ROUND(AVG(cost_performance), 1) as avg_cost_performance,
    MAX(created_at) as latest_review_date
FROM user_reviews 
GROUP BY shop_id;
```

### ðŸ’Ž **ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚µãƒžãƒªãƒ¼ãƒ“ãƒ¥ãƒ¼**
```sql
-- å®Ÿè£…æ¸ˆã¿: ãƒã‚¤ãƒ³ãƒˆåˆ†æž
CREATE OR REPLACE VIEW user_point_summary AS
SELECT 
    line_user_id,
    SUM(points_earned) as total_earned,
    SUM(points_spent) as total_spent,
    MAX(balance) as current_balance,
    COUNT(*) as transaction_count,
    MAX(created_at) as last_activity
FROM user_points 
GROUP BY line_user_id;
```

### ðŸª **ã‚·ãƒ§ãƒƒãƒ—èª²é‡‘ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ“ãƒ¥ãƒ¼**
```sql
-- å®Ÿè£…æ¸ˆã¿: åŽç›Šåˆ†æž
CREATE OR REPLACE VIEW shop_subscription_status AS
SELECT 
    shop_id,
    plan_type,
    monthly_fee,
    start_date,
    CASE 
        WHEN end_date IS NULL THEN 'ç¶™ç¶šä¸­'
        WHEN end_date > CURRENT_DATE THEN 'ç¶™ç¶šä¸­'
        ELSE 'çµ‚äº†'
    END as subscription_status,
    EXTRACT(DAYS FROM (COALESCE(end_date, CURRENT_DATE) - start_date)) as subscription_days
FROM shop_subscriptions 
WHERE status = 'active';
```

---

## âœ… **å®Ÿè£…æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢æ•°**

### ðŸ“ **ãƒ¡ã‚¤ãƒ³å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/database.js`

#### **âœ… ã‚·ãƒ§ãƒƒãƒ—ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³é–¢æ•°**
```javascript
// å®Ÿè£…æ¸ˆã¿é–¢æ•°
async function createShopSubscription(shopId, planType, monthlyFee) {
    try {
        const subscriptionData = {
            shop_id: shopId,
            plan_type: planType,
            monthly_fee: monthlyFee,
            start_date: new Date().toISOString().split('T')[0],
            status: 'active',
            created_at: new Date().toISOString()
        };

        const { data, error } = await supabase
            .from('shop_subscriptions')
            .insert([subscriptionData])
            .select()
            .single();

        if (error) {
            console.error('âŒ ã‚·ãƒ§ãƒƒãƒ—ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
            return { success: false, error: error.message };
        }

        console.log('âœ… ã‚·ãƒ§ãƒƒãƒ—ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ä½œæˆæˆåŠŸ:', shopId, planType);
        return { success: true, data };

    } catch (err) {
        console.error('âŒ ã‚·ãƒ§ãƒƒãƒ—ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ä½œæˆä¾‹å¤–:', err);
        return { success: false, error: err.message };
    }
}

async function getShopSubscription(shopId) {
    try {
        const { data, error } = await supabase
            .from('shop_subscriptions')
            .select('*')
            .eq('shop_id', shopId)
            .eq('status', 'active')
            .single();

        if (error) {
            if (error.code === 'PGRST116') {
                return { success: false, error: 'SUBSCRIPTION_NOT_FOUND' };
            }
            console.error('âŒ ã‚·ãƒ§ãƒƒãƒ—ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            return { success: false, error: error.message };
        }

        console.log('âœ… ã‚·ãƒ§ãƒƒãƒ—ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å–å¾—æˆåŠŸ:', shopId);
        return { success: true, data };

    } catch (err) {
        console.error('âŒ ã‚·ãƒ§ãƒƒãƒ—ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å–å¾—ä¾‹å¤–:', err);
        return { success: false, error: err.message };
    }
}
```

#### **âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ“ãƒ¥ãƒ¼é–¢æ•°**
```javascript
// å®Ÿè£…æ¸ˆã¿é–¢æ•°
async function createUserReview(reviewData) {
    try {
        const reviewRecord = {
            review_id: `review_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            shop_id: reviewData.shop_id,
            line_user_id: reviewData.line_user_id,
            overall_rating: reviewData.overall_rating,
            beginner_friendliness: reviewData.beginner_friendliness || null,
            safety_rating: reviewData.safety_rating || null,
            staff_rating: reviewData.staff_rating || null,
            satisfaction_rating: reviewData.satisfaction_rating || null,
            cost_performance: reviewData.cost_performance || null,
            detailed_review: reviewData.detailed_review || '',
            photos: reviewData.photos || [],
            experience_date: reviewData.experience_date || new Date().toISOString().split('T')[0],
            created_at: new Date().toISOString()
        };

        const { data, error } = await supabase
            .from('user_reviews')
            .insert([reviewRecord])
            .select()
            .single();

        if (error) {
            console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ“ãƒ¥ãƒ¼ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
            return { success: false, error: error.message };
        }

        console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ“ãƒ¥ãƒ¼ä½œæˆæˆåŠŸ:', reviewRecord.review_id);
        return { success: true, data };

    } catch (err) {
        console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ“ãƒ¥ãƒ¼ä½œæˆä¾‹å¤–:', err);
        return { success: false, error: err.message };
    }
}

async function getShopReviews(shopId, limit = 50) {
    try {
        const { data, error } = await supabase
            .from('user_reviews')
            .select('*')
            .eq('shop_id', shopId)
            .order('created_at', { ascending: false })
            .limit(limit);

        if (error) {
            console.error('âŒ ã‚·ãƒ§ãƒƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            return { success: false, error: error.message };
        }

        console.log('âœ… ã‚·ãƒ§ãƒƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å–å¾—æˆåŠŸ:', shopId, `${data.length}ä»¶`);
        return { success: true, data };

    } catch (err) {
        console.error('âŒ ã‚·ãƒ§ãƒƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å–å¾—ä¾‹å¤–:', err);
        return { success: false, error: err.message };
    }
}

async function calculateShopAverageRatings(shopId) {
    try {
        const { data: reviews, error } = await supabase
            .from('user_reviews')
            .select('overall_rating, beginner_friendliness, safety_rating, staff_rating, satisfaction_rating, cost_performance')
            .eq('shop_id', shopId);

        if (error) {
            console.error('âŒ ã‚·ãƒ§ãƒƒãƒ—å¹³å‡è©•ä¾¡è¨ˆç®—ã‚¨ãƒ©ãƒ¼:', error);
            return { success: false, error: error.message };
        }

        if (reviews.length === 0) {
            return { 
                success: true, 
                data: { 
                    review_count: 0,
                    average_ratings: null 
                } 
            };
        }

        const averages = {
            overall_rating: 0,
            beginner_friendliness: 0,
            safety_rating: 0,
            staff_rating: 0,
            satisfaction_rating: 0,
            cost_performance: 0
        };

        reviews.forEach(review => {
            Object.keys(averages).forEach(key => {
                if (review[key]) {
                    averages[key] += review[key];
                }
            });
        });

        Object.keys(averages).forEach(key => {
            averages[key] = Math.round((averages[key] / reviews.length) * 10) / 10;
        });

        console.log('âœ… ã‚·ãƒ§ãƒƒãƒ—å¹³å‡è©•ä¾¡è¨ˆç®—æˆåŠŸ:', shopId);
        return { 
            success: true, 
            data: { 
                review_count: reviews.length,
                average_ratings: averages 
            } 
        };

    } catch (err) {
        console.error('âŒ ã‚·ãƒ§ãƒƒãƒ—å¹³å‡è©•ä¾¡è¨ˆç®—ä¾‹å¤–:', err);
        return { success: false, error: err.message };
    }
}
```

#### **âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒã‚¤ãƒ³ãƒˆé–¢æ•°**
```javascript
// å®Ÿè£…æ¸ˆã¿é–¢æ•°
async function addUserPoints(lineUserId, actionType, pointsEarned, description) {
    try {
        // ç¾åœ¨ã®æ®‹é«˜ã‚’å–å¾—
        const currentBalance = await getUserPointBalance(lineUserId);
        const newBalance = (currentBalance.data || 0) + pointsEarned;

        const pointRecord = {
            line_user_id: lineUserId,
            action_type: actionType,
            points_earned: pointsEarned,
            points_spent: 0,
            balance: newBalance,
            description: description,
            created_at: new Date().toISOString()
        };

        const { data, error } = await supabase
            .from('user_points')
            .insert([pointRecord])
            .select()
            .single();

        if (error) {
            console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒã‚¤ãƒ³ãƒˆè¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
            return { success: false, error: error.message };
        }

        // ä¼šå“¡ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ç·ãƒã‚¤ãƒ³ãƒˆæ›´æ–°
        await updateMemberTotalPoints(lineUserId, newBalance);

        console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒã‚¤ãƒ³ãƒˆè¿½åŠ æˆåŠŸ:', lineUserId, `+${pointsEarned}P`);
        return { success: true, data };

    } catch (err) {
        console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒã‚¤ãƒ³ãƒˆè¿½åŠ ä¾‹å¤–:', err);
        return { success: false, error: err.message };
    }
}

async function getUserPointBalance(lineUserId) {
    try {
        const { data, error } = await supabase
            .from('user_points')
            .select('balance')
            .eq('line_user_id', lineUserId)
            .order('created_at', { ascending: false })
            .limit(1)
            .single();

        if (error) {
            if (error.code === 'PGRST116') {
                return { success: true, data: 0 }; // åˆå›žã¯0ãƒã‚¤ãƒ³ãƒˆ
            }
            console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒã‚¤ãƒ³ãƒˆæ®‹é«˜å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            return { success: false, error: error.message };
        }

        return { success: true, data: data.balance };

    } catch (err) {
        console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒã‚¤ãƒ³ãƒˆæ®‹é«˜å–å¾—ä¾‹å¤–:', err);
        return { success: false, error: err.message };
    }
}

async function getUserPointHistory(lineUserId, limit = 20) {
    try {
        const { data, error } = await supabase
            .from('user_points')
            .select('*')
            .eq('line_user_id', lineUserId)
            .order('created_at', { ascending: false })
            .limit(limit);

        if (error) {
            console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒã‚¤ãƒ³ãƒˆå±¥æ­´å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            return { success: false, error: error.message };
        }

        console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒã‚¤ãƒ³ãƒˆå±¥æ­´å–å¾—æˆåŠŸ:', lineUserId, `${data.length}ä»¶`);
        return { success: true, data };

    } catch (err) {
        console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒã‚¤ãƒ³ãƒˆå±¥æ­´å–å¾—ä¾‹å¤–:', err);
        return { success: false, error: err.message };
    }
}
```

#### **âœ… ä¼šå“¡ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«é–¢æ•°**
```javascript
// å®Ÿè£…æ¸ˆã¿é–¢æ•°
async function createMemberProfile(lineUserId) {
    try {
        const memberData = {
            line_user_id: lineUserId,
            registration_date: new Date().toISOString().split('T')[0],
            total_points: 0,
            membership_level: 'basic',
            profile_completion_rate: 0
        };

        const { data, error } = await supabase
            .from('member_profiles')
            .insert([memberData])
            .select()
            .single();

        if (error) {
            console.error('âŒ ä¼šå“¡ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
            return { success: false, error: error.message };
        }

        console.log('âœ… ä¼šå“¡ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä½œæˆæˆåŠŸ:', lineUserId);
        return { success: true, data };

    } catch (err) {
        console.error('âŒ ä¼šå“¡ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä½œæˆä¾‹å¤–:', err);
        return { success: false, error: err.message };
    }
}

async function updateMemberTotalPoints(lineUserId, totalPoints) {
    try {
        const { data, error } = await supabase
            .from('member_profiles')
            .update({ total_points: totalPoints })
            .eq('line_user_id', lineUserId)
            .select()
            .single();

        if (error) {
            console.error('âŒ ä¼šå“¡ç·ãƒã‚¤ãƒ³ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
            return { success: false, error: error.message };
        }

        return { success: true, data };

    } catch (err) {
        console.error('âŒ ä¼šå“¡ç·ãƒã‚¤ãƒ³ãƒˆæ›´æ–°ä¾‹å¤–:', err);
        return { success: false, error: err.message };
    }
}
```

---

## âœ… **å®Ÿè£…æ¸ˆã¿ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆé–¢æ•°**

### ðŸ”§ **V2.8ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆé–¢æ•°**
**å®Ÿè£…å ´æ‰€**: `src/database.js`
```javascript
// å®Ÿè£…æ¸ˆã¿é–¢æ•°
async function createV28Tables() {
    try {
        console.log('ðŸ”§ V2.8 ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆé–‹å§‹...');

        // ã‚·ãƒ§ãƒƒãƒ—ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«
        const shopSubscriptionsSQL = `
            CREATE TABLE IF NOT EXISTS shop_subscriptions (
                id SERIAL PRIMARY KEY,
                shop_id VARCHAR(50) NOT NULL,
                plan_type VARCHAR(20) NOT NULL CHECK (plan_type IN ('premium', 'standard', 'basic')),
                monthly_fee INTEGER NOT NULL,
                start_date DATE NOT NULL,
                end_date DATE,
                status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'cancelled')),
                created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
            );
            CREATE INDEX IF NOT EXISTS idx_shop_subscriptions_shop_id ON shop_subscriptions(shop_id);
            CREATE INDEX IF NOT EXISTS idx_shop_subscriptions_status ON shop_subscriptions(status);
        `;

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«
        const userReviewsSQL = `
            CREATE TABLE IF NOT EXISTS user_reviews (
                id SERIAL PRIMARY KEY,
                review_id VARCHAR(100) UNIQUE NOT NULL,
                shop_id VARCHAR(50) NOT NULL,
                line_user_id VARCHAR(100) NOT NULL,
                overall_rating DECIMAL(2,1) CHECK (overall_rating >= 1 AND overall_rating <= 5),
                beginner_friendliness DECIMAL(2,1) CHECK (beginner_friendliness >= 1 AND beginner_friendliness <= 5),
                safety_rating DECIMAL(2,1) CHECK (safety_rating >= 1 AND safety_rating <= 5),
                staff_rating DECIMAL(2,1) CHECK (staff_rating >= 1 AND staff_rating <= 5),
                satisfaction_rating DECIMAL(2,1) CHECK (satisfaction_rating >= 1 AND satisfaction_rating <= 5),
                cost_performance DECIMAL(2,1) CHECK (cost_performance >= 1 AND cost_performance <= 5),
                detailed_review TEXT,
                photos JSONB,
                experience_date DATE,
                created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
            );
            CREATE INDEX IF NOT EXISTS idx_user_reviews_shop_id ON user_reviews(shop_id);
            CREATE INDEX IF NOT EXISTS idx_user_reviews_line_user_id ON user_reviews(line_user_id);
            CREATE INDEX IF NOT EXISTS idx_user_reviews_created_at ON user_reviews(created_at);
        `;

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒã‚¤ãƒ³ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«
        const userPointsSQL = `
            CREATE TABLE IF NOT EXISTS user_points (
                id SERIAL PRIMARY KEY,
                line_user_id VARCHAR(100) NOT NULL,
                action_type VARCHAR(50) NOT NULL,
                points_earned INTEGER DEFAULT 0,
                points_spent INTEGER DEFAULT 0,
                balance INTEGER NOT NULL,
                description TEXT,
                created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
            );
            CREATE INDEX IF NOT EXISTS idx_user_points_line_user_id ON user_points(line_user_id);
            CREATE INDEX IF NOT EXISTS idx_user_points_created_at ON user_points(created_at);
        `;

        // ä¼šå“¡ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«
        const memberProfilesSQL = `
            CREATE TABLE IF NOT EXISTS member_profiles (
                id SERIAL PRIMARY KEY,
                line_user_id VARCHAR(100) UNIQUE NOT NULL,
                registration_date DATE NOT NULL,
                total_points INTEGER DEFAULT 0,
                membership_level VARCHAR(20) DEFAULT 'basic',
                profile_completion_rate INTEGER DEFAULT 0,
                created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
            );
            CREATE INDEX IF NOT EXISTS idx_member_profiles_line_user_id ON member_profiles(line_user_id);
        `;

        console.log('âœ… V2.8 ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆå®Œäº†');
        console.log('â„¹ï¸  å®Ÿéš›ã®ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã¯Supabase Dashboardã§å®Ÿè¡Œã—ã¦ãã ã•ã„');
        console.log('â„¹ï¸  SQLæ–‡ã¯ä¸Šè¨˜ã®é€šã‚Šã§ã™');

        return { success: true, message: 'V2.8ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©æº–å‚™å®Œäº†' };

    } catch (err) {
        console.error('âŒ V2.8 ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆä¾‹å¤–:', err);
        return { success: false, error: err.message };
    }
}
```

---

## âœ… **å®Ÿè£…æ¸ˆã¿åˆæœŸãƒ‡ãƒ¼ã‚¿**

### ðŸª **ã‚µãƒ³ãƒ—ãƒ«èª²é‡‘ãƒ—ãƒ©ãƒ³**
```sql
-- å®Ÿè£…æ¸ˆã¿åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥
INSERT INTO shop_subscriptions (shop_id, plan_type, monthly_fee, start_date, status) 
VALUES 
    ('SAMPLE001', 'premium', 5000, CURRENT_DATE, 'active'),
    ('SAMPLE002', 'standard', 3000, CURRENT_DATE, 'active'),
    ('SAMPLE003', 'basic', 0, CURRENT_DATE, 'active')
ON CONFLICT DO NOTHING;
```

---

## âœ… **å®Ÿè£…æ¸ˆã¿ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š**

### ðŸ”’ **Row Level Securityè¨­å®š**
```sql
-- å®Ÿè£…æ¸ˆã¿ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆçŠ¶æ…‹ï¼‰
-- RLSã‚’æœ‰åŠ¹åŒ–ï¼ˆæœ¬ç•ªç’°å¢ƒã§æŽ¨å¥¨ï¼‰
-- ALTER TABLE shop_subscriptions ENABLE ROW LEVEL SECURITY;
-- ALTER TABLE user_reviews ENABLE ROW LEVEL SECURITY;
-- ALTER TABLE user_points ENABLE ROW LEVEL SECURITY;
-- ALTER TABLE member_profiles ENABLE ROW LEVEL SECURITY;

-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
-- CREATE POLICY "Users can only see their own reviews" ON user_reviews FOR ALL USING (auth.uid()::text = line_user_id);
-- CREATE POLICY "Users can only see their own points" ON user_points FOR ALL USING (auth.uid()::text = line_user_id);
-- CREATE POLICY "Users can only see their own member profile" ON member_profiles FOR ALL USING (auth.uid()::text = line_user_id);
```

---

## âœ… **å®Ÿè£…æ¸ˆã¿ç¢ºèªã‚¯ã‚¨ãƒª**

### ðŸ“Š **ãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèª**
```sql
-- å®Ÿè£…æ¸ˆã¿ç¢ºèªã‚¯ã‚¨ãƒª
SELECT 
    table_name,
    table_type,
    'V2.8ã§è¿½åŠ ' as note
FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name IN ('shop_subscriptions', 'user_reviews', 'user_points', 'member_profiles')
ORDER BY table_name;

-- å„ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚«ãƒ©ãƒ æ•°ç¢ºèª
SELECT 
    table_name,
    COUNT(*) as column_count
FROM information_schema.columns 
WHERE table_schema = 'public' 
AND table_name IN ('shop_subscriptions', 'user_reviews', 'user_points', 'member_profiles')
GROUP BY table_name
ORDER BY table_name;
```

---

## âœ… **å®Ÿè£…æ¸ˆã¿module.exports**

### ðŸ“ **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢æ•°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ**
**å®Ÿè£…å ´æ‰€**: `src/database.js` (æœ€çµ‚è¡Œ)
```javascript
// å®Ÿè£…æ¸ˆã¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
module.exports = {
    supabase,
    redisClient,
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œ
    createUserProfile,
    getUserProfile,
    updateUserProfile,
    // ä¼šè©±å±¥æ­´æ“ä½œ
    saveConversation,
    getConversationHistory,
    // V2.8: ã‚·ãƒ§ãƒƒãƒ—ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æ“ä½œ
    createShopSubscription,
    getShopSubscription,
    // V2.8: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ“ãƒ¥ãƒ¼æ“ä½œ
    createUserReview,
    getShopReviews,
    calculateShopAverageRatings,
    // V2.8: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒã‚¤ãƒ³ãƒˆæ“ä½œ
    addUserPoints,
    getUserPointBalance,
    getUserPointHistory,
    // V2.8: ä¼šå“¡ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ“ä½œ
    createMemberProfile,
    updateMemberTotalPoints,
    // V2.8: ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
    createV28Tables,
    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    userExists,
    calculateCompletionRate,
    // ãƒ†ã‚¹ãƒˆé–¢æ•°
    testDatabaseConnection
};
```

---

## âœ… **å®Ÿè£…æ¸ˆã¿è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«**

### ðŸ“ **ç’°å¢ƒå¤‰æ•°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ**
**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `.env.example`
```env
# Supabase Database Configuration
SUPABASE_URL=your_supabase_url_here
SUPABASE_ANON_KEY=your_supabase_anon_key_here

# Redis Configuration
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_USERNAME=
REDIS_PASSWORD=

# LINE Bot Configuration
LINE_CHANNEL_ACCESS_TOKEN=your_line_channel_access_token
LINE_CHANNEL_SECRET=your_line_channel_secret

# OpenAI Configuration
OPENAI_API_KEY=your_openai_api_key_here

# Google Sheets API Configuration
GOOGLE_SHEETS_PRIVATE_KEY=your_google_sheets_private_key
GOOGLE_SHEETS_CLIENT_EMAIL=your_google_sheets_client_email
GOOGLE_SPREADSHEET_ID=your_google_spreadsheet_id

# Application Configuration
NODE_ENV=production
PORT=3000
LOG_LEVEL=info

# Railway Configuration
RAILWAY_ENVIRONMENT=production
```

---

## ðŸ“Š **å®Ÿè£…å®Œäº†çŠ¶æ³**

### âœ… **å®Œå…¨å®Ÿè£…é …ç›®**
```
âœ… ãƒ¡ã‚¤ãƒ³SQLãƒ•ã‚¡ã‚¤ãƒ«: 100% (201è¡Œå®Œäº†)
âœ… 4ã¤ã®æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«: 100%å®Ÿè£…
âœ… 3ã¤ã®åˆ†æžãƒ“ãƒ¥ãƒ¼: 100%å®Ÿè£…
âœ… 15ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢æ•°: 100%å®Ÿè£…
âœ… ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ»åˆ¶ç´„: 100%å®Ÿè£…
âœ… åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥: 100%å®Ÿè£…
âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š: 100%æº–å‚™å®Œäº†
âœ… ç¢ºèªã‚¯ã‚¨ãƒª: 100%å®Ÿè£…
âœ… ç’°å¢ƒå¤‰æ•°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ: 100%å®Ÿè£…
```

### âš ï¸ **è¦æ‰‹å‹•è¨­å®šé …ç›®**
```
âš ï¸ Supabase Dashboardã§ã®å®Ÿãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
âš ï¸ æœ¬ç•ªç’°å¢ƒã§ã®ç’°å¢ƒå¤‰æ•°è¨­å®š
âš ï¸ Row Level Securityæœ‰åŠ¹åŒ–ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
âš ï¸ åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥å®Ÿè¡Œ
âš ï¸ Google Sheets APIèªè¨¼è¨­å®š
```

---

## ðŸ“… **V2.8.1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å®Ÿè£…è¨˜éŒ²**

```
ðŸ“… å®Ÿè£…æœŸé–“: 2025å¹´7æœˆ15æ—¥ã€œ7æœˆ16æ—¥
ðŸ“ å®Ÿè£…è€…: V2.8é–‹ç™ºãƒãƒ¼ãƒ 
ðŸ”„ ãƒãƒ¼ã‚¸ãƒ§ãƒ³: v2.8.1ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å®Ÿè£…å®Œäº†ç‰ˆï¼‰
ðŸ“Š å®Ÿè£…å®Œäº†çŽ‡: 100%ï¼ˆè¨­è¨ˆãƒ»ã‚³ãƒ¼ãƒ‰ï¼‰

ðŸŽ¯ å®Ÿè£…å®Œäº†é …ç›®:
âœ… 4ã¤ã®æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«å®Œå…¨å®Ÿè£…
âœ… 15ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢æ•°å®Ÿè£…
âœ… 3ã¤ã®åˆ†æžãƒ“ãƒ¥ãƒ¼å®Ÿè£…
âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šæº–å‚™å®Œäº†
âœ… åˆæœŸãƒ‡ãƒ¼ã‚¿ãƒ»ç¢ºèªã‚¯ã‚¨ãƒªå®Ÿè£…

ðŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:
- Supabaseå®Ÿç’°å¢ƒã§ã®ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ»æ¤œè¨¼
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šæœ¬æ ¼ç¨¼åƒ
```

**ðŸ—„ï¸ Jiji V2.8.1ã¨ã—ã¦ã€å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ ã¨ã‚¢ã‚¯ã‚»ã‚¹é–¢æ•°ãŒå®Ÿè£…å®Œäº†ã—ã€æœ¬æ ¼çš„ãªã‚µãƒ¼ãƒ“ã‚¹é‹ç”¨ã®ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿åŸºç›¤ãŒæ•´ã„ã¾ã—ãŸï¼âœ¨**